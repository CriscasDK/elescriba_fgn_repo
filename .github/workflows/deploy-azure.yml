name: ğŸš€ Deploy RAG System to Azure Container Apps

on:
  push:
    branches: [main]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '*.md'
  pull_request:
    branches: [main]

env:
  REGISTRY_NAME: ragdocsjudiciales
  APP_NAME: rag-documentos-judiciales
  RESOURCE_GROUP: rg-documentos-judiciales
  CONTAINER_APP_ENVIRONMENT: env-documentos-judiciales

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ğŸ“¦ Checkout cÃ³digo
    - name: ğŸ“¦ Checkout repository
      uses: actions/checkout@v4

    # ğŸ” Login a Azure
    - name: ğŸ” Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # ğŸ³ Setup Docker Buildx
    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ğŸ—ï¸ Login a Azure Container Registry
    - name: ğŸ—ï¸ Login to Azure Container Registry
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.REGISTRY_NAME }}.azurecr.io
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    # ğŸ”¨ Build y Push Docker image
    - name: ğŸ”¨ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:latest
          ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    # ğŸš€ Deploy a Azure Container Apps
    - name: ğŸš€ Deploy to Azure Container Apps
      uses: azure/container-apps-deploy-action@v1
      with:
        appSourcePath: ${{ github.workspace }}
        acrName: ${{ env.REGISTRY_NAME }}
        containerAppName: ${{ env.APP_NAME }}
        resourceGroup: ${{ env.RESOURCE_GROUP }}
        imageToDeploy: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ github.sha }}
        containerAppEnvironment: ${{ env.CONTAINER_APP_ENVIRONMENT }}

    # âœ… Verificar deployment
    - name: âœ… Verify deployment
      run: |
        echo "ğŸ‰ Deployment completed!"
        echo "ğŸ“Š Application: ${{ env.APP_NAME }}"
        echo "ğŸ”— Registry: ${{ env.REGISTRY_NAME }}.azurecr.io"
        echo "ğŸ“‹ Resource Group: ${{ env.RESOURCE_GROUP }}"
        
        # Obtener URL de la aplicaciÃ³n
        APP_URL=$(az containerapp show \
          --name ${{ env.APP_NAME }} \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --query properties.configuration.ingress.fqdn \
          --output tsv)
        
        echo "ğŸŒ App URL: https://$APP_URL"

  # ğŸ§ª Tests de integraciÃ³n (opcional)
  integration-tests:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ§ª Run basic health check
      run: |
        echo "ğŸ” Running integration tests..."
        # AquÃ­ puedes agregar tests especÃ­ficos
        echo "âœ… Health check passed!"